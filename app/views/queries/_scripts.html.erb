<%= javascript_tag do %>
$(function() {
  $( "#datepicker_from" ).datetimepicker({lang:'ru', format:'d.m.Y H:i'});
});
$(function() {
  $( "#datepicker_to" ).datetimepicker({lang:'ru', format:'d.m.Y H:i'});
});

$(function() {
    
    window.options_both_day = {
      chart:  {
                renderTo: 'chart_both_day',
                spacingBottom: 30,
                marginTop: 60,
                zoomType: 'x'
              },
      title:  {
                text: 'Общая динамика по дням'
              },
      subtitle: {
                text: null
              },
      xAxis:  {
                type: 'datetime',
                tickInterval: 3 * 24 * 3600 * 1000,
                tickWidth: 0,
                gridLineWidth: 1,
                labels: {
                  align: 'left',
                  x: 3,
                  y: 16
                }
              },
      yAxis: [{ // Primary yAxis
                labels: {
                    style: {
                        color: Highcharts.getOptions().colors[0]
                    }
                },
                title: {
                    text: 'Количество статей',
                    style: {
                        color: Highcharts.getOptions().colors[0]
                    }
                }
              }, { // Secondary yAxis
                title: {
                  text: 'Тональность статей',
                  style: {
                    color: Highcharts.getOptions().colors[2]
                  }
                },
                labels: {
                  style: {
                    color: Highcharts.getOptions().colors[2]
                  }
                },
                opposite: true,
                min: -3,
                max: 3
              }],
      tooltip: {
                shared: true
                },
      legend: {
                layout: 'vertical',
                align: 'left',
                x: 120,
                verticalAlign: 'top',
                y: 100,
                floating: true,
                backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColor) || '#FFFFFF'
              },
      series: [{
                name: 'Количество',
                type: 'column'
              }, {
                name: 'Тональность',
                type: 'spline',
                yAxis: 1    
              }]
    };//Options bot_day
    window.options_both_hour = {
      chart:  {
                renderTo: 'chart_both',
                spacingBottom: 30,
                marginTop: 60,
                zoomType: 'x'
              },
      title:  {
                text: 'Общая динамика по дням'
              },
      subtitle: {
                text: null
              },
      xAxis:  {
                type: 'datetime',
                tickInterval: 3 * 24 * 3600 * 1000,
                tickWidth: 0,
                gridLineWidth: 1,
                labels: {
                  align: 'left',
                  x: 3,
                  y: 16
                }
              },
      yAxis: [{ // Primary yAxis
                labels: {
                    style: {
                        color: Highcharts.getOptions().colors[0]
                    }
                },
                title: {
                    text: 'Количество статей',
                    style: {
                        color: Highcharts.getOptions().colors[0]
                    }
                }
              }, { // Secondary yAxis
                title: {
                  text: 'Тональность статей',
                  style: {
                    color: Highcharts.getOptions().colors[2]
                  }
                },
                labels: {
                  style: {
                    color: Highcharts.getOptions().colors[2]
                  }
                },
                opposite: true,
                min: -3,
                max: 3
              }],
      tooltip: {
                shared: true
                },
      legend: {
                layout: 'vertical',
                align: 'left',
                x: 120,
                verticalAlign: 'top',
                y: 100,
                floating: true,
                backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColor) || '#FFFFFF'
              },
      series: [{
                name: 'Количество',
                type: 'column'
              }, {
                name: 'Тональность',
                type: 'spline',
                yAxis: 1    
              }]
    };//Options both day



    window.options_both_hour = {
      chart:  {
                renderTo: 'chart_both_hour',
                spacingBottom: 30,
                marginTop: 60,
                zoomType: 'x'
              },
      title:  {
                text: 'Общая динамика по часам'
              },
      subtitle: {
                text: null
              },
      xAxis:  {
                type: 'datetime',
                tickInterval: 3 * 24 * 3600 * 1000,
                tickWidth: 0,
                gridLineWidth: 1,
                labels: {
                  align: 'left',
                  x: 3,
                  y: 16
                }
              },
      yAxis: [{ // Primary yAxis
                labels: {
                    style: {
                        color: Highcharts.getOptions().colors[0]
                    }
                },
                title: {
                    text: 'Количество статей',
                    style: {
                        color: Highcharts.getOptions().colors[0]
                    }
                }
              }, { // Secondary yAxis
                title: {
                  text: 'Тональность статей',
                  style: {
                    color: Highcharts.getOptions().colors[2]
                  }
                },
                labels: {
                  style: {
                    color: Highcharts.getOptions().colors[2]
                  }
                },
                opposite: true,
                min: -3,
                max: 3
              }],
      tooltip: {
                shared: true
                },
      legend: {
                layout: 'vertical',
                align: 'left',
                x: 120,
                verticalAlign: 'top',
                y: 100,
                floating: true,
                backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColor) || '#FFFFFF'
              },
      series: [{
                name: 'Количество',
                type: 'column'
              }, {
                name: 'Тональность',
                type: 'spline',
                yAxis: 1,
                lineWidth: 2,
                marker: {
                    radius: 3
                }    
              }]
    };//Options bot_day
    window.options_both_hour = {
      chart:  {
                renderTo: 'chart_both_hour',
                spacingBottom: 30,
                marginTop: 60,
                zoomType: 'x'
              },
      title:  {
                text: 'Общая динамика по часам'
              },
      subtitle: {
                text: null
              },
      xAxis:  {
                type: 'datetime',
                tickInterval: 3 * 24 * 3600 * 1000,
                tickWidth: 0,
                gridLineWidth: 1,
                labels: {
                  align: 'left',
                  x: 3,
                  y: 16
                }
              },
      yAxis: [{ // Primary yAxis
                labels: {
                    style: {
                        color: Highcharts.getOptions().colors[0]
                    }
                },
                title: {
                    text: 'Количество статей',
                    style: {
                        color: Highcharts.getOptions().colors[0]
                    }
                }
              }, { // Secondary yAxis
                title: {
                  text: 'Тональность статей',
                  style: {
                    color: Highcharts.getOptions().colors[2]
                  }
                },
                labels: {
                  style: {
                    color: Highcharts.getOptions().colors[2]
                  }
                },
                opposite: true,
                min: -3,
                max: 3
              }],
      tooltip: {
                shared: true
                },
      legend: {
                layout: 'vertical',
                align: 'left',
                x: 120,
                verticalAlign: 'top',
                y: 100,
                floating: true,
                backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColor) || '#FFFFFF'
              },
      series: [{
                name: 'Количество',
                type: 'column'
              }, {
                name: 'Тональность',
                type: 'spline',
                yAxis: 1    
              }]
    };//Options both hour
  });//function
  parseDate = function (s) {
    var match = s[0].match(/^([0-9]{1,2})\.([0-9]{1,2})\.([0-9]{2}) ([0-9]{1,2}):([0-9]{1,2})$/);
    if (match) {
      var d = Date.UTC(+('20' + match[3]), match[2] - 1, +match[1], +match[4], +match[5]);
      return [d, s[1]];
    }
  }

  $(function() {
    $.ajax({
      url: '/queries/<%= @query.id %>/chart_data?source=<%= source %>'
    }).done(function(data) {
      Highcharts.setOptions({
            lang: {
                loading: 'Загрузка...',
                months: ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'],
                weekdays: ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'],
                shortMonths: ['Янв', 'Фев', 'Март', 'Апр', 'Май', 'Июнь', 'Июль', 'Авг', 'Сент', 'Окт', 'Нояб', 'Дек'],
                exportButtonTitle: "Экспорт",
                printButtonTitle: "Печать",
                rangeSelectorFrom: "С",
                rangeSelectorTo: "По",
                rangeSelectorZoom: "Период",
                downloadPNG: 'Скачать PNG',
                downloadJPEG: 'Скачать JPEG',
                downloadPDF: 'Скачать PDF',
                downloadSVG: 'Скачать SVG',
                printChart: 'Напечатать график'
            }
    });
      var parsed_data_emot_hour = data.emot.map(parseDate);
      var parsed_data_count_hour = data.count.map(parseDate);
      var parsed_data_emot_day = data.day_emot.map(parseDate);
      var parsed_data_count_day = data.day_count.map(parseDate);
      window.options_both_day.series[0].data = parsed_data_count_day;
      window.options_both_day.series[1].data = parsed_data_emot_day;
      window.options_both_hour.series[0].data = parsed_data_count_hour;
      window.options_both_hour.series[1].data = parsed_data_emot_hour;
      Highcharts.setOptions(Highcharts.theme);
      var chart_day = new Highcharts.Chart(window.options_both_day);
      var chart_hour = new Highcharts.Chart(window.options_both_hour);
    });
  });  
<% end %>