<div id="chart" class="col-md-10 col-md-offset-1" style="height: 400px;"></div>

<% if @query %>
	<h2> Новости по запросу "<%= @query.title %>" </h2>
<% end %>
<% @texts.each do |text| %>
	<p>
		<%= link_to "#anc#{text.id}" do %>
			<b> <%= text.title %> </b> 
			(<%= text.url.length > 20 ? text.url[0..20] + "..." : text.url %>)
		<% end %>
	</p>
<% end %>

<% @texts.each do |text| %>
		<div class="article">
			<button type="button" class="btn btn-info essence" onclick="javascript:location.href='<%= category_query_text_path(params[:category_id], text.query.id, text.id) %>'">Выделить сущности</button>
			<p><a name="<%= "anc#{text.id}" %>"></a><b> <%= text.title %> </b> </p>
			<p> <%= link_to text.url, text.url, target: "_blank" %> </p>
			<p> <%= text.content %> </p>
			<p align="right"> Новость от: <%= text.created_at.strftime("%H:%M:%S") %></p>
			<hr>
			<div id="emotion_<%= text.id %>">
				Эмоциональность: <div class="emot emot_<%= text.emot.to_i + 3 %>"> <%= text.emot %> </div>
				<% if text.my_emot %>
				Реальная эмоциональность: <div class="emot emot_<%= text.my_emot.to_i + 3 %>"> <%= text.my_emot %> </div>
			<% else %>
			</div>
			
				<form id="feedback_<%= text.id %>" action="http://emot.zaelab.ru/feedback.json" method="POST" style="display: block;" data-remote="true" class="feedback" textid="<%= text.id %>">
				  <input type="hidden" name="text" value="<%= text.content %>">
				  <input type="hidden" name="revision" value="2">
				  <input type="hidden" name="score" value="">
				  <p><strong>Как вы бы сами оценили этот текст?</strong></p>
				  <input type="submit" value="(-3) критический" onclick="setFeedbackScore(<%= text.id %>,-3);">
				  <input type="submit" value="(-2) негативный" onclick="setFeedbackScore(<%= text.id %>,-2);">
				  <input type="submit" value="(-1) неблагоприятный" onclick="setFeedbackScore(<%= text.id %>,-1);">
				  <input type="submit" value="(0) нейтральный" onclick="setFeedbackScore(<%= text.id %>,0);">
				  <input type="submit" value="(+1) благоприятный" onclick="setFeedbackScore(<%= text.id %>,1);">
				  <input type="submit" value="(+2) позитивный" onclick="setFeedbackScore(<%= text.id %>,2);">
				  <input type="submit" value="(+3) прекрасный" onclick="setFeedbackScore(<%= text.id %>,3);">
				  <script type="text/javascript">
				    function setFeedbackScore(id, score) {
				      document.forms['feedback_' + id]['score'].value = score
				      return true
				    }
				  </script>
				</form>
			<% end %>
		</div>
<% end %>

<%= javascript_tag do %>
	$(function() {

	  window.options = {
	    chart: {
	      renderTo: 'chart',
	      type: 'spline'
	    },
		  title: {
        text: 'Эмоциональность статей'
      },

      subtitle: {
        text: null
      },

      xAxis: {
        type: 'datetime',
        tickInterval: 24 * 3600 * 1000,
        tickWidth: 0,
        gridLineWidth: 1,
        labels: {
          align: 'left',
          x: 3,
          y: -3
        }
      },

      yAxis: [{ // left y axis
        title: {
          text: null
        },
        labels: {
          align: 'left',
          x: 3,
          y: 16,
          format: '{value:.,0f}'
        },
        showFirstLabel: false
      }, { // right y axis
          linkedTo: 0,
          gridLineWidth: 0,
          opposite: true,
          title: {
            text: null
          },
          labels: {
            align: 'right',
            x: -3,
            y: 16,
            format: '{value:.,0f}'
          },
          showFirstLabel: false
      }],

      legend: {
        align: 'left',
        verticalAlign: 'top',
        y: 20,
        floating: true,
        borderWidth: 0
      },

      tooltip: {
        shared: true,
        crosshairs: true
      },

      plotOptions: {
        series: {
          cursor: 'pointer',
          marker: {
            lineWidth: 1
          }
        }
      },

      series: [{}]
    };
  });
	parseDate = function (s) {
    var match = s[0].match(/^([0-9]{1,2})\.([0-9]{1,2})\.([0-9]{2}) ([0-9]{1,2}):([0-9]{1,2})$/);
    if (match) {
      var d = Date.UTC(+('20' + match[3]), match[2] - 1, +match[1], +match[4], +match[5]);
      return [d,s[1]];
    }
  }

	$(function() {
		$.ajax({
  		url: '/queries/<%= @query.id %>/chart_data'
		}).done(function(data) {
			var parsed_data = data.map(parseDate);
			console.log(parsed_data);
			window.options.series[0].data = parsed_data;
	  	var chart = new Highcharts.Chart(window.options);
		});
	});  
<% end %>